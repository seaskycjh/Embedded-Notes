## ARM体系架构

[TOC]

------

### 1 ARM处理器简介

#### 1.1 ARM处理器的特点和应用

采用RISC（精简指令集计算机）架构，具有以下**特点**：

- 体积小、功耗低、成本低、高性能。
- 支持Thumb(16位)/ARM(32位)双指令集。
- 具有大量寄存器，因而指令执行速度快。
- 绝大多数操作在寄存器中进行，通过Load/Store体系架构在内存和寄存器间传递数据。
- 寻址方式简单。
- 采用固定长度的指令格式。

**应用场合**：

无线通信、蓝牙技术、网络应用、消费类电子产品、信息家电。

### 2 ARM处理器系列

Classic系列基于ARMv1~ARMv6架构，ARM Cortex-A、Cortex-M、Cortex-R系列都基于ARMv7体系架构，Cortex-A50基于ARMv8架构。

#### 2.1 Classic(传统)系列

由三个子系列组成：ARM7系列、ARM9系列、ARM11系列。

#### 2.2 Cortex-M系列

主要针对成本和功耗敏感的应用，如智能测量、人机接口、汽车和工业控制系统、家用电器、消费性产品和医疗器械等。包括Cortex-M0、Cortex-M0+、Corte-M1、Cortex-M3、Cortex-M4五个子系列。

#### 2.3 Cortex-R系列

对低功耗、良好中断行为、性能以及平台兼容性进行了平衡，具有高性能、实时、安全和经济实惠的特点，面向深层嵌入式实时应用。包括Cortex-R4、Cortex-R5、Cortex-R7三个子系列。

#### 2.4 Cortex-A系列

用于具有高计算要求、运行丰富操作系统以及提供交互媒体和图形体验的应用领域，如智能手机、平板电脑、汽车娱乐系统、数字电视等，包括Cortex-A5、Cortex-A7、Cortex-A8、Cortex-A9、Cortex-A12、Cortex-A15六个子系列。

#### 2.5 Cortex-A50架构

3 ARM编程模型

#### 3.1 ARM硬件架构

ARM芯片的内核一般包括以下几个单元：

处理器、数据缓存器、指令缓存器、指令存储管理单元、数据存储管理单元、写缓存、回写存储单元。

这些单元通过AMBA总线相互传输数据以实现指令和数据并行处理。

四个与外界进行数据交换的接口：总线接口、扩展协处理器接口、跟踪接口、JTAG。

#### 3.2 ARM处理器模式

ARM处理器有7种运行模式，通常情况下应用程序运行在用户模式下，不能访问受操作系统保护的系统资源，也不能进行处理器模式切换。

- 用户模式(User)：正常程序执行时。
- 快速中断模式(FIQ)：用于快速的数据处理和通道处理。
- 外部中断模式(IRQ)：用于通常中断处理。
- 特权模式(Supervisor)：供操作系统使用的一种保护模式。
- 数据访问中止模式(Abort)：当数据或指令预期终止时，用于虚拟存储及存储保护。
- 未定义指令终止模式(Undefined)：用于支持硬件协处理器软件仿真。
- 系统模式(System)：用于运行特权级的操作系统任务。

#### 3.3 ARM寄存器

ARM处理器共有37个寄存器，包括31个通用寄存器和6个状态寄存器，都是32位的。

**通用寄存器**：通用寄存器中R0-R7是所有处理器模式共用的一组寄存器，当切换处理器模式时，必须保存它们的值。R8-R14为备份寄存器。R13通常用作堆栈指针。

R14寄存器有两个特殊的作用：

- 用户模式下，R14用做链接寄存器（LR），存放子程序被调用时的的返回地址。
- 异常处理模式下，R14用来保存异常的返回地址。

R15为程序计数器（PC），ARM采用流水线机制，因此PC的值为当前指令地址值加8个字节，即指向当前指令的下两条指令的地址。

**程序状态寄存器**：用来保存程序执行时的各种状态值，包括条件标志位、中断禁止位、当前处理器模式标志和其他一些位。分为CPSR和SPSR两种，当异常发生时，SPSR用于存放CPSR的内容。

#### 3.4 异常处理

ARM体系结构中，将正常的程序执行流程发生暂时的停止情况都称为异常，中断也是其中的一种，且分为外部普通中断和外部快速中断两种。处理异常前，当前处理器的状态必须保留，以便当异常处理完成后，被打断的程序可以继续执行。

**异常类型**：

| 异常类型     | 具体含义 |
| ------------ | -------- |
| 复位         |          |
| 未定义指令   |          |
| 软件中断     |          |
| 指令预取中止 |          |
| 数据中止     |          |
| IRQ          |          |
| FIQ          |          |

**异常向量表及优先级**：

**对异常的响应**：

- 将下一条指令的地址存入相应的LR,以便程序处理异常返回时能从正确位置重新开始执行。
- 将CPSR复制到相应的SPSR中。
- 根据发生的异常类型，强制设置CPSR的运行模式位，此后ARM内核进入对应的异常工作模式。
- 强制PC值为相关的异常向量地址，该地址存放着软件处理异常函数的入口地址。从而跳转到对应的异常处理程序，之后由软件接管，处理异常并返回。

**从异常返回**：

- 将LR的值减去相应偏移量后送到PC中。
- 将SPSR复制回CPSR中。
- 若进入异常处理时设置了中断禁止位，要在此清除。

#### 3.5 ARM存储器组织

ARM以虚拟地址的方式对存储器进行组织。使用MMU单元来管理存储器。

**大小端字节序**：

当存储一个32位数据0x11223344到地址0x100上时，若为小端字节序，则0x100地址上存放数据0x44、0x101位0x33、0x102为0x22、0x103为0x11，即高位数据放在高位地址，地位数据放在低位地址。大端字节序则相反。

**MMU**：

平板式地址映射机制下，对地址空间的分配是固定的，系统使用物理地址，这就造成程序员必须自己管理内存，而且应用程序出错可能会使整个内核崩溃。

因此很多ARM内核使用虚拟内存映射机制，整个内存由内存管理单元（MMU）进行管理，整个系统使用虚拟地址，再由MMU将其映射为实际的物理地址。

MMU的主要工作为：

- 虚拟存储空间到物理存储空间的映射。在ARM中，物理地址和虚拟地址都使用分页机制，即把空间分为一个个大小固定的块，每一块称为一页，物理空间的页和虚拟地址的页大小相同。
- 存储器访问权限的控制。

### 4 ARM指令系统

#### 4.1 ARM指令格式

ARM每条指令都是32位的，编码格式为：

opcode（21~24）：指令操作符编码。

cond（28~31）：指令执行的条件编码。

S（20）：决定指令的操作是否影响CPSR的值。

Rd（12~15）：目标寄存器编码。

Rn（16~19）：包含第一个操作数的寄存器编码。

Shift_operand（0~11）：第二个操作数，可以是一个寄存器、移位的寄存器或立即数。

指令格式为：

`<opcode>{<cond>} {S} <Rd>, <Rn>{, <operand2>}`

4.2 ARM指令的寻址方式

4.3 ARM常用指令

ARM微处理器指令集：

- 跳转指令
- 数据处理指令
- 程序状态寄存器（PSR）处理指令
- 加载/存储（Load/Store）指令
- 协处理器指令
- 异常中断产生指令



