## TCP/IP

### 1 TCP/IP协议

#### 1.1 OSI模型、TCP/IP模型

**OSI协议参考模型**：从上到下共分为7层：应用层、表示层、会话层、传输层、网络层、数据链路层及物理层。

**TCP/IP协议参考模型**：一共分为4层，自上而下分别是：应用层：负责应用程序的网络访问，这里通过**端口号**来识别各个不同的进程。
传输层：负责端对端之间的通信会话连接与建立。传输协议的选择根据数据传输方式而定。
网络层：负责将数据帧封装成IP数据包，并运行必要的路由算法。网络接口层：负责将二进制流转换为数据帧，并进行数据帧的发送和接收。数据帧是独立的网络信息传输单元。

#### 1.2 TCP/IP协议族

TCP/IP实际上是一个庞大的协议族，包括了各个层次上的众多协议。
应用层：talnet、fp
传输层：TCP、UDP
网络层：ICMP、IGMP、IPv4、IPv6
网络接口层：ARP、RARP、MPLS
网络编程中涉及传输层TCP和UDP协议。

#### 1.3 TCP

TCP的上一层就是应用层，因此，TCP数据传输实现了从一个应用程序到另一个应用程序的数据传递。应用程序通过编程调用TCP并使用TCP服务，提供需要发送的数据、用来区分接收数据应用的目的地址和端口号。通常应用程序通过打开一个socket来使用TCP服务，TCP管理到其他socket的数据传递。通过IP的源/目的可以惟一地区分网络中两个设备的连接，通过socket的源/目的可以惟一地区分网络中两个应用程序的连接。
**三次握手协议**
TCP 对话通过三次握手来进行初始化。三次握手的目的是使数据段的发送和接收同步，告诉其他主机其一次可接收的数据量，并建立虚连接。
1）请求主机发送一个连接请求报文。(SYN J)
2）接收主机接收连接后回复ACK报文，并为此连接分配资源。(SYN K, ACK J+1)
3）请求主机回送ACK报文，并分配资源。(ACK K+1)

```sequence
客户端->服务端: SYN J
服务端->客户端: SYN K, ACK J+1
客户端->服务端: ACK K+1
```

**四次挥手协议**

1）客户端发送一个FIN，用来关闭数据传送。(FIN M)

2）服务器收到FIN，发回一个ACK，确认序号加1。(ACK M+1)

3）服务器关闭此连接，并发送一个FIN给客户端。(FIN N)

4）客户端发回ACK报文确认，并将确认序号加1。(ACK N+1)

```sequence
客户端->服务端: FIN M
服务端->客户端: ACK M+1
服务端->客户端: FIN N
客户端->服务端: ACK N+1
```

**TCP 数据包头**

1）源端口、目的端口：都为16位。标识出远端和本地的端口号。

2）序号：32位长。标识发送的数据报的顺序。

3）确认号：32位长。希望收到的下一个数据包的序列号。

4）TCP头长：4位长。表明 TCP 头中包含多少个 32 位字。其后6位未用。

ACK：ACK位为1表明确认号是合法的。若ACK为0，则数据报不包含确认信息，确认字段被省略。

PSH：表示是带有PUSH标志的数据。接收方因此请求数据包一到便将其送往应用程序而不必等到缓冲区装满时才传送。

RST：用于复位由于主机崩溃或其他原因而出现的错误连接。还可以用于拒绝非法的数据包或拒绝连接请求。
SYN：用于建立连接。

FIN：用于释放连接。
窗口大小：16位长，表示在确认了字节之后还可以发送多少个字节。

5）校验和、紧急指针：16位长。

6）可选项：0或多个32位字。

#### 1.4 UDP

即用户数据报协议，它是一种无连接协议，一个UDP应用可同时作为应用的客户或服务器方。。它比TCP协议更为高效，也能更好地解决实时性的问题。
(1)UDP 数据报头
源地址、目的地址：16位长。标识出远端和本地的端口号。
数据报的长度是指包括报头和数据部分在内的总的字节数。

#### 1.5 协议的选择

(1)对数据可靠性的要求，高可靠性的应用需选择TCP协议。

(2)应用的实时性，高实时性的应用需选择UDP协议。

(3)网络的可靠性，网络状况不好时选用TCP协议，网络状况很好时选用UDP协议。