### Link Layer

#### 1 概述

1.1 链路层状态

链路层的操作用状态机来描述，有以下 5 种状态：

- 待机（Standby）状态：链路层不传输或接收任何数据包。
- 广播（Advertising）状态：链路层传输广播信道包并监听和响应由这些包触发的响应。
- 扫描（Scanning）状态：链路层侦听正在广播的设备的广播信道包。
- 发起（Initiating）状态：链路层侦听来自特定设备的广播信道包，并响应这些数据包来发起一个连接。
- 连接（Connection）状态：处于连接状态的设备称为处于连接中。

连接状态定义了两种角色：

- 主角色（Master）：从发起状态进入连接状态。
- 从角色（Slave）：从广播状态进入连接状态。

初始化

1.3 设备地址

蓝牙设备由设备地址来标识。设备地址可以是公共设备地址，也可以是随机设备地址，它们的长度都是 48 位。

1.3.1 公共设备地址

公共设备地址（public device address）根据 IEEE 802-2001 标准创建，是 48位的通用 LAN MAC 地址，包含两个字段：

- 公司分配（company_assigned）：24 位（LSB）。
- 公司标识（company_id）：24 位（MSB）。

1.3.2 随机设备地址

可分为两种类型：

静态设备地址：48位随机生成的地址，需满足以下要求：

- 最高有效位的前两位需置 1。
- 剩余的位不能全为 1 或 全为 0。

设备可在上电后设置其静态地址，一旦设置就不能改变，直到电源重启。

私有设备地址：可分为可解析私有地址和不可解析私有地址。

不可解析私有地址需满足以下要求：

- 最高有效位的前两位为 0。
- 剩余的位不能全为 0/1。

要生成可解析私有地址，设备必须具有本地身份解析键（IRK）或配对身份解析键（IRK）

1.4 物理信道

2.4GHz ISM 频带定义了 40 个射频通道（RF Channel），这些射频通道被分配到广播和数据两个 LE 物理通道。广播物理通道使用了 3 个射频通道（2402、2426、2480），数据物理通道则使用剩下的 37 个射频通道。

2 空中接口数据包

### 2.1 包格式

链路层只有一种数据包格式，用于广播信道数据包和数据信道数据包。

数据包由四个字段组成：前导（Preamble）、访问地址（Access Address）、PDU 和 CRC。

前导为 1 字节，访问地址为 4 字节，PDU 为 2~257字节，CRC 为 3 字节，所以最短的包长为 80 bits，最长的包长为 2120 bits。

传输顺序为：前导 -> 访问地址 -> PDU -> CRC。

2.1.1 前导

在接收机中，前导用于执行频率同步、符号定时估计和自动增益控制训练。

广播信道包的前导为 10101010b。

数据通道包的前导由访问地址的 LSB 决定，若 LSB 为 1，前导为 01010101b，否则为 10101010b。

2.1.2 访问地址

**广播信道包**的访问地址是固定的，都为 0x8E89BED6。

**数据通道包**的访问地址对于每个链路层连接来说是不同的，是一个随机的 32 位值，由处于发起状态的设备生成并在连接请求中发送，访问地址需符合以下要求。

- 不能有超过 6 个连续的 0 或 1。
- 不应与广播信道包的访问地址只有一位不同。
- 四个字节不应都相同。
- 过渡最多不超过 24 个。

2.1.3 PDU

分为广播通道 PDU 和 数据通道 PDU，见 2.3 和 2.4。

2.1.4 CRC

2.3 广播通道 PDU

广播信道 PDU 由一个 16 位的包头（Header）和一个可变长度的负载（payload）组成。

包头由以下字段组成：

**PDU Type**（4位）指示了 PDU 的类型，如下表所示：

| PDU Type  | 包名            |
| --------- | --------------- |
| 0000      | ADV_IND         |
| 0001      | ADV_DIRECT_IND  |
| 0010      | ADV_NONCONN_IND |
| 0011      | SCAN_REQ        |
| 0100      | SCAN_RSP        |
| 0101      | CONNECT_REQ     |
| 0110      | ADV_SCAN_IND    |
| 0111-1111 | 保留            |

**RFU**（2位）：

**TxAdd**（1位）：用于指示广播者（advertiser）的地址类型。

**RxAdd**（1位）：用于指示发起者（initiator）的地址类型。

**Length**（6位）：广播包的总长度。

**RFU**（2位）：

2.3.1 广播 PDUs

ADV_IND：可连接非定向广播事件。Payload 由 AdvA（6 字节，包含广播者的设备地址） 和 AdvData（0~31字节，包含了广播者的广播数据） 两个字段组成。

ADV_DIRECT_IND：可连接非定向广播事件。Payload 由 AdvA（6 字节，包含广播者的设备地址）和 InitA（6 字节，包含发起者的设备地址）两个字段组成。

ADV_NONCONN_IND：不可连接非定向广播事件。Payload 同 ADV_IND。

ADV_SCAN_IND：可扫描非定向广播事件。Payload 同 ADV_IND。

2.3.2 扫描 PDUs

SCAN_REQ：由处于扫描状态的链路层发送，被处于广播状态的链路层接收。Payload 由 ScanA（6 字节，包含扫描者的设备地址）和 AdvA（6 字节，包含广播者的设备地址）两个字段组成。

SCAN_RSP：由处于广播状态的链路层发送，被处于扫描状态的链路层接收。Payload 由 AdvA（6 字节，包含广播者的设备地址）和 ScanRspData（0~31 字节，包含广播者的任意数据）。

2.3.3 发起 PDUs

CONNECT_REQ：由发起状态的链路层发送，被广播状态的链路层接收。由 InitA（6 字节，包含发起者的设备地址）、AdvA（6 字节，包含广播者的设备地址）和 LLData（22 字节，由 10 个字段组成）。

LLData 包含以下 10 个字段：

- AA：4 字节，包含链路层的访问地址。
- CRCInit：3 字节，包含链路层连接的 CRC 校验的初始值。
- WinSize：1 字节，指示传输窗的大小。
- WinOffset：2 字节，指示传输窗偏移量的大小。
- Interval：2 字节，指示连接间隔的大小。
- Latency：2 字节，指示从机忽略的值。
- Timeout：2 字节，指示连接管理超时的值。
- ChM：5 字节，指示使用/未使用的数据通道的信道映射。
- Hop：5 位，指示数据通道选择时使用的跳频增量。
- SCA：3 位，确定主睡眠时钟精度。

2.4 数据信道 PDU

数据通道 PDU 具有一个 16 位的头部（header）、一个可变长度的负载（payload），可能包含一个消息完整性检测（MIC）字段。

头部由 5 个字段组成：

LLID：

### 4 空中接口协议

空中接口协议包括多址接入方案、设备发现和链路层连接方法。

#### 4.1 帧间空间

同一信道上的两个连续数据包之间的时间间隔称为帧间空间，被定义为从上个数据包的最后一位结束到下一个数据包的第一位开始的时间。帧间空间必须为 150us 。

#### 4.2 时间要求

链路层应使用两种可能的时钟精度之一。在连接或广播事件期间，链路层应使用活跃时钟精度，否则使用睡眠时钟精度。

4.2.1 活跃时钟精度

一个连接事件期间包传输的平均时间被确定为活动时钟精度，

4.2.2 睡眠时钟精度

广播事件和连接事件的定时采用睡眠时钟精度。

#### 4.3 链路层设备过滤

链路层可根据对等设备的设备地址来执行设备过滤，链路层使用链路层设备过滤来最小化它响应的设备的数量。

链路层应该支持链路层设备过滤，除非它只支持不可连接的广播。

广播、扫描和发起状态的过滤策略相互独立。

##### 4.3.1 白名单

链路层用于设备过滤的设备集合称为白名单。

白名单包含一组白名单记录用于链路层设备过滤。白名单记录包含设备地址和设备地址类型。支持链路层设备过滤的链路层至少要存储一个白名单记录。

白名单由主机配置，并由链路层用于过滤广播设备、扫描设备或发起设备。

##### 4.3.2 广播过滤策略

广播过滤策略决定了广播者的链路层如何处理扫描或连接请求。

当链路层使用可连接的定向广播时，忽略广播过滤策略，否则链路层将使用以下广播过滤策略中的一种：

- 链路层只处理白名单设备的扫描和连接请求。
- 链路层处理所有设备的扫描和连接请求。
- 链路层处理所有设备的扫描请求，且只处理白名单设备的连接请求。
- 链路层处理所有设备的连接请求，且只处理白名单设备的扫描请求。

##### 4.3.3 扫描过滤策略

扫描过滤策略决定了扫描者的链路层如何处理广播包。链路层使用一下扫描过滤策略中的一种：

- 链路层只处理白名单设备的广播包。不包含扫描设备地址的可连接定向广播包应被忽略。
- 链路层处理所有广播包。

若链路层支持扩展扫描策略，则还需支持以下模式：

- 链路层只处理白名单设备的广播包。
- 链路层处理所有广播包。

##### 4.3.4 发起过滤策略

#### 4.4 无连接状态

#### 4.5 连接状态

当发起者发送 CONNECT_REQ PDU  到广播者或广播者收到来自发起者的 CONNECT_REQ PDU  时，链路层进入连接状态。

进入连接状态后，连接被认为创建（create）完成。此时不认为连接已建立（establish），只有接收到配对设备的数据通道包后才认为连接已经被建立。

当两个设备连接在一起时，两个设备扮演不同的角色，扮演主角色的链路层称为主设备，扮演从角色的链路层称为从设备。主设备控制连接事件的时序。一个连接事件是主从之间的一个同步点。两个 LE 设备地址间只能有一个连接。

##### 4.5.1 连接事件

链路层在连接状态下只能传输连接事件中的数据信道包。主从双方应为每个连接事件确定数据通道索引。

在连接事件期间，主/从设备交替发送和接收数据包。当双方持续发送数据包时认为连接事件是打开的。连接事件可以由任意一方关闭。

连接事件的开始称为锚点（anchor point）。在锚点，主设备开始传输一个数据通道 PDU 到从设备。连接事件的开始有规律地间隔为一个连接间隔，且不应重叠。主设备应确保连接事件在下一次连接事件的锚点之前至少关闭 T_IFS。从设备在锚点监听由主设备发送的数据包。

##### 4.5.2 超时监控

由于各种原因（如设备超出范围、收到严重干扰或停电等）都可能使连接中断。这些情况可能在没有任何预告的情况下发送，因此对于主/从机来说，监控连接的状态非常重要。

为了能够检测链路丢失，主机和从机都应该使用一个链路层连接监控定时器。当接收到有效数据包时，定时器将被重置。

在连接建立之前，若链路层连接监控计时器达到6个连接间隔（即在长达6个连接间隔的时间里没有收到数据包），则视为连接丢失。这样可以快速终止无法建立的连接。

连接监控超时（Connection Supervision Timeout）是一个参数，它定义了连接丢失之前接收到两个数据包间的最大时间间隔。超时时间应为 10ms 的倍数，在 100ms 到 32s 之间，且应大于 (1 + connSlaveLatency) * connInterval * 2。

若连接已经建立，且计时器达到了连接监控超时值，则视为连接丢失。连接丢失后，链路层不再发送任何数据包，并退出连接状态，转换到待机状态。主机（Host）将被告知连接丢失。

##### 4.5.3 连接事件传输窗口

为了允许主角色有效地为多个连接或其他活动安排连接事件，主角色可以灵活地在其选择的时间内安排第一个连接时间锚点（anchor）。连接请求数据包包含了确定在连接状态下主角色何时发送他的第一个数据包以及何时从角色必须侦听的参数。



4.6 特性支持

5 链路层控制

5.1 链路层控制过程

5.1.1 连接更新过程

连接参数可能会在进入连接后更新，如果主/从设备不支持连接参数请求过程，主设备可以通过发送 LL_CONNECTION_UPDATE_REQ PDU  来发起连接参数更新。从设备不应该发送这个 PDU。

链路层应从主机给出的间隔范围（connIntervalmin ~ connIntervalmax）中确定连接间隔的值，并向主机指示所选的间隔值。

5.1.2 通道映射更新过程

6 隐私

链路层使用私有地址来提供隐私。若设备使用了可解析的私有地址，则它必须有一个身份地址（可以是一个公共地址或随机静态地址）。

6.1 私有地址生成

链路层需设置一个定时器（时间由主机决定），当定时器到期时会生成一个新的私有地址。若链路层复位，一个新的私有地址会被生成。

注意：如果私有地址生成频繁，连接建立时间可能会受到影响。建议将定时器设置为15分钟。

6.2 广播状态的隐私

广播状态的隐私决定了链路层处理广播事件的可解析私有地址的方式。