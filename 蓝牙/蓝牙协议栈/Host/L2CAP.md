L2CAP

1 简介

L2CAP 即逻辑链路控制和适应层协议（Logical Link Control and Adaptation Layer Protocol），它为上层协议提供面向连接和无连接的数据服务，具有协议复用和分段重组能力。L2CAP 允许高级别的协议和应用程序传输和接收最大长度为 64kb 的上层数据包（L2CAP 服务数据单元，SDU），还允许每个通道流量控制和重传。

L2CAP 层提供逻辑通道，可以在一个或多个逻辑链接上多路复用。

- 协议/通路多路复用：用于传输用户数据的逻辑链路只有一条，而 L2CAP 需要服务的上层协议不止一个，因此需要使用多路复用的手段，这种手段简单且直接，即在数据发送时，将用户数据分割为一定长度的数据包，在加上一个包含特定 ID 的 header 后通过逻辑链路发送出去。数据接收时，从逻辑链路接收数据，解析其中的ID，以此来判断需要将数据发送到哪个应用。
- 基于连接的方法：这里的连接是基于 L2CAP 应用程序的，在通信前，先建立一个基于 Logic Channel 的虚拟通道（L2CAP Channel，类似于 TCP/IP 中的端口）。L2CAP 为此通道分配一个编号，称为 Channel ID（简称 CID）。
- 无连接的方法：主要应用在提高数据传输效率，方便广播通信等场景，只允许在 BR/EDR 中使用。
- 分段和重组
- 每个 L2CAP 通道流控制
- 错误控制和重传
- 支持流传输
- 分片和重组
- 服务质量

2 通用操作

2.1 信道标识符

信道标识符（channel identifier，CID）是表示设备上的逻辑通道端点的本地名称。CID 的范围与逻辑链接有关。空标识符（0x0000）永远不能作为目标端点。0x0001~0x003F 的 CID 是为特定的 L2CAP 函数保留的，这些信道被称为固定信道。

固定通道特征包括配置参数（如可靠性、MTU 大小、QoS）、安全性和更改参数的能力（利用 L2CAP 配置机制）。

注意：两个同时活动的 L2CAP 通道不能共享一个 CID。

2.2 设备间的操作

当用于广播传输时，无连接信道将数据流限制在一个方向上。当用于单播传输时，无连接信道可以在主从之间的任何方向上使用。

3 数据包格式

L2CAP 是基于数据包的但遵循基于通道的通信模型。通道表示远程设备中 L2CAP 实体之间的数据流，通道可以是面向连接的，也可以是无连接的。L2CAP 无连接通道（0x0002）和两个信令通道（0x0001，0x0005）之外的固定通道是面向连接的，所有动态分配 CID 的通道都是面向连接的。



