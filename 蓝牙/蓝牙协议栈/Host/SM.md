SM

1 简介

安全管理器（SM）使用密钥分发方式来执行无线通信中的标识和加密功能。密钥的强度由设备内部实现的算法决定。

执行配对（Pair）以建立密钥，然后可以使用密钥加密链接。执行特定于传输的密钥分发以共享密钥，这些密钥用于未来重新连接时加密链接、验证签名数据和随机地址解析。

配对是一个三阶段的过程，前两个阶段总是被使用，后一个阶段是可选的。

- 阶段1：配对特征交换。
- 阶段2：（LE Legacy Pairing）生成短期密钥（STK）。
- 阶段2：（LE Secure Connections）生成长期密钥（LTK）。
- 阶段3：传输特定密钥分发

设备首先在配对特征交换过程中交换身份验证要求和 IO 能力，以此来确定在阶段2使用下列方法中的哪一种：

- 仅工作。
- 数字比较（仅适用于 LE 安全连接）。
- 密钥输入。
- 带外（OOB）。

阶段1检索到的身份验证需求决定了使用 LE 安全连接还是 LE 遗留配对。

2.2 加密工具箱

为了支持随机寻址、配对以及其他操作，SM 提供了一个加密函数工具箱。定义了以下加密函数：

- ah 用于创建一个 24 位散列（用于随机地址的创建和解析）。

定义了以下密码函数来支持 LE Legacy Pairing 过程：

- c1 用于生成配对过程中使用的确认值。
- s1 用于生成配对过程中的 STK。

定义了以下加密函数来支持 LE Secure Connections 过程：

- f4 用于生成配对过程中的确认值。
- f5 用于生成配对过程中的 LTK 和 MacKey。
- f6 用于生成配对过程中身份验证阶段2的检查值。
- g2 用于生成配对过程中身份验证阶段1的 6 位数字的比较值。
- h6 用于生成

2.2.1 安全函数 e

安全函数 e 从 128 位密钥和 128 位明文数据生成 128 位的加密数据：`encryptedData = e(key, plaintextData)`。

2.2.2 随机地址哈希函数 ah

以下是函数 ah 的输入：k（128 bits），r（24 bits），padding（104 bits）。

r 与 padding 连接生成 r'，r' 作为函数 e 的明文数据：`r' = padding || r`。

函数 ah 的输出为：ah(k, r) = e(k, r') mod 2^24^

2.2.3 函数 c1

函数 c1 的输出为：`c1(k, r, preq, pres, iat, rat, ia, ra) = e(k, e(k, r XOR p1) XOR p2)`。

2.2.4 函数 s1

函数 s1 的输出为：`s1(k, r1, r2) = e(k, r')`。

2.3 配对方法

开始配对时，启动设备应启动配对特征交换。

配对特征交换用于交换 IO能力，OOB身份验证数据可用性，身份验证需求，密钥大小需求以及分发密钥的传输方式。IO能力，OOB身份验证数据可用性，身份验证需求用于确定配对过程中的密钥生成方法并生成两个键：

身份认证要求由 GAP 设置，包括绑定类型和中间人（man-in-the-middle，MITM）保护要求。

2.3.1 安全特性

2.3.2 IO 能力

一个设备的输入和输出能力结合产生它的 IO 能力。

2.3.3 OOB 身份认证数据

带外机制用于交流配对过程中使用的信息。该信息应该是一个序列广告数据结构。

如果设备有对等设备的带外认证数据，则应设置 OOB 数据标志。

2.3.4 加密密钥大小

2.3.5 配对算法

- 选择密钥生成方法：
- LE 遗留配对-仅工作：
- LE 遗留配对-密钥输入：
- 带外：
- LE 遗留配对

2.4 BLE 安全性

2.4.1 密钥和值定义

LE 安全使用下列密钥和值用于加密、签名和随机地址：

- 身份解析密钥（IRK）是一个 128 位的密钥用于生成和解析随机地址。
- 连接签名解析密钥（CSRK）是一个 128 位的密钥用于数据签名并验证接收设备上的签名。
- 长期密钥（LTK）是一个 128 位的密钥用于为加密的连接生成贡献会话密钥。
- 加密多样性（EDIV）是一个 16 位的存储值，用于标识 LE 遗留配对中分布的 LTK，每次分发一个唯一的 LTK 时，都会生成一个新的 EDIV。
- 随机数（Rand）是一个 64 位的存储值，用于标识 LE 遗留配对中分布的 LTK，每次分发一个唯一的 LTK 时，都会生成一个新的 Rand。



3 安全管理协议

安全管理器协议（SMP）用于配对和传输特定密钥分发。

3.1 基于 L2CAP 的安全管理通道

3.2 命令格式

SMP 命令格式由以下字段组成：

- Code（1字节）：用于标识命令的类型。
- Data（0~22/64字节）：Code 字段决定了 Data 字段的格式。

3.3 配对方法

定义了用于执行配对特性交换和密钥生成的 SMP 命令。

3.3.1 配对请求

启动程序通过向响应设备发送配对请求命令来启动配对特性交换。

3.3.2 配对响应

响应设备使用此命令来完成配对。

3.3.3 配对确认

当配对特性交换成功完成后，此命令用于启动 STK 生成。

3.3.4 配对随机

启动和响应设备使用该命令发送用于计算配对确认命令中发送的确认值的随机数。

3.3.5 配对失败

当配对过程出现故障，并报告配对过程已经停止且不再发生进一步通信时，可以使用此命令。

3.3.6 配对公共密钥

用于将设备的本地公钥传输到远程设备。

3.3.7 配对 DHKey 检查

3.3.8 按键通知

