HCI

1 简介

HCI（Host Controller Interface）提供了访问蓝牙控制器功能的统一接口方法。主机可以驱动一个主控制器和多个（或零个）AMP 控制器，主控制器应支持以下功能之一：

- 只支持 BR/EDR。
- 只支持 LE。
- 支持 BR/EDR/LE。

1.1 底层蓝牙协议栈

主机将收到 HCI 事件的异步通知，与使用哪个主机控制器传输层无光。HCI 事件用于在发送事件时通知主机。当主机发现发生了某个事件时，它将解析接收到的事件包来确定发生了哪个事件。

BR/EDR/LE 控制器使用一个共享的命令缓冲区和流控制。数据缓冲区可以在 BR/EDR 和 LE 之间共享，也可以为 BR/EDR 和 LE 提供单独的数据缓冲区。控制器的配置可以通过 HCI 确定。

LE 控制器使用一组简化的 HCI 命令和事件。一些命令和事件被重用于多种控制器类型。

2 主机控制器传输层概述

HCI 驱动和主机之间有一个传输层。这个传输层的主要目的是透明性。主机控制器驱动应该独立于底层传输技术。此外，传输无需理解主机控制器驱动传递给控制器的数据的意义。这允许 HCI 或控制器在不影响传输层的情况下进行升级。

3 命令和事件概述

命令和事件在主机和控制器之间发生，他们按功能分为逻辑组。

| 组           | 描述                                                 |
| ------------ | ---------------------------------------------------- |
| 通用事件     | 通用事件可能由于多个命令或任意时间发生的事件而产生   |
| 设备设置     | 设备设置命令用于将控制器置于移植状态                 |
| 控制器流控制 | 控制器流控制命令和事件用于控制从主机到控制器的数据流 |
| 控制器信息   | 控制器信息命令允许主机发现设备的本地信息             |
| 控制器配置   | 控制器配置命令和事件允许配置全局配置参数             |
| 设备发现     | 设备发现命令和事件允许设备发现周围的其他设备         |
| 连接设置     | 连接设置命令和事件允许设备连接到另一个设备           |
| 远程信息     | 远程信息命令和事件允许发现远程设备配置相关的信息     |

3.1 通用事件

通用事件是由多个命令或随时可能发生的事件引起的。

4 HCI 流控制

数据的流控制应使用在主机到控制器的方向上，以避免带有发往无响应远程设备的 ACL 数据的控制器数据缓冲溢出。主机管理控制器的数据缓冲区。对于主控制器，基于数据包的流控制是默认的。对于 AMP 控制器，基于数据块的流控制是默认的

5 HCI 数据格式

5.4 HCI 特定信息交换

5.4.1 HCI 命令包

HCI 命令包用于主机向控制器发送命令。

控制器需能接受包含 255 字节数据的 HCI 命令包头。

每个命令分配一个 2 字节的操作码，用于唯一标识不同类型的命令。操作码参数分为两个字段：操作码组字段（OGF）和操作码命令字段（OCF）。OGF 占用操作码的前 6 位，OCF 占用其余的 10 位。

6 事件

6.1 LE Meta Event

此事件用于封装所有特定于 LE 控制器的事件。所有 LE 元事件的事件代码都是 0x3E。副事件码为事件参数的首字节。

6.1.1 LE Connection Complete Event

描述：

事件参数：Subevent_Code = 0x01。

Status：

6.1.2 LE Advertising Report Event

描述：此事件标识一个或多个蓝牙设备对主动扫描作出响应，或者在被动扫描期间接收到信息。控制器可以对这些广播报告进行排队并在一个 LE 广播报告事件中从多个设备发送信息。

事件参数：Subevent_Code = 0x02。

报告数量（Num_Reports）：1 字节，事件中响应的数量，范围是 0 ~ 25。

事件类型（Event_Type[i]）：1 * Num_Reports 字节，

地址类型（Address_Type[i]）：

地址（Address[i]）：广播设备的地址。

数据长度（Length_Data[i]）：

数据（Data[i]）：广播或扫描回应的数据。

RSSI[i]：

6.1.3：

7 命令

1.1 LE Read Local Supported Features Command

描述：此命令请求控制器支持的 LE 特性的列表。

命令参数：无。

返回值：0x00 成功

0x01~0xFF 失败

支持特性：见 LL 的 4.6。

1.2 LE Set Random Address Command

描述：主机利用此命令来设置 LE 控制器的随机设备地址。

命令参数：Random_Addess 见 LL 的 1.3

返回值：Status：0x00 成功

1.5 LE Set Advertising Parameters Command

1.12 LE Create Connection Command

描述：此命令用于创建一个链路层连接到一个可连接的广播者。

命令参数：扫描窗的值应小于或等于扫描间隔，若两者相等，则扫描会连续进行。

- 扫描间隔（LE_Scan_Interval）：主机建议控制器扫描的频率。
- 扫描窗（LE_Scan_Window）：主机建议控制器应扫描多长时间。
- 发起者过滤策略（Initiator_Filter_Policy）：1 字节，用于确定是否使用白名单。若不使用白名单，则需指定配对地址类型和配对地址。
- 配对地址类型（Peer_Address_Type）：
- 配对地址（Peer_Address）：
- 所有者地址（Own_Address_Type）：
- 最小连接间隔（Conn_Interval_Min）：
- 最大连接间隔（Conn_Interval_Max）：
- 连接延迟（Conn_Latency）：
- 超时监督（Supervision_Timeout）：
- 最小 CE 长度：
- 最大 CE 长度：



