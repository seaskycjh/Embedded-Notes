### 学习总结

#### 1 熟悉开发环境

1.1 搭建开发环境

1.2 学习开发软件和调试工具的使用

- MDK5 的使用。
- 逻辑分析仪、BLE Sniffer。
- Source Insight、SecureCRT、SSH。

1.3 学习 git 的使用

Git 的使用，包括环境配置、初始化项目、添加/删除文件、提交更新、管理分支、管理远程仓库等。

#### 2 入门开发

2.1 ATB110X 开发板的使用

了解开发板的硬件资源，了解 DAPLINK 的配置和使用，包括在线调试和固件烧写。

2.2 ZS 110A SDK

- ZS110A SDK架构（驱动层、内核层、子系统层、应用层）。
- ROM 由 BROM 和 Zephyr-Rom 组成，BROM 负责引导和烧写固件，Zephyr-Rom 包含 zephyr 内核/驱动/子系统。
- spinor 分区：Loader-A/B、APP-A/B、NVRAM-FACTORY、NVRAM-USER。
- 启动流程：BROM 引导 Loader，Loader 引导 App，_main->main->\_PrepC->app_main。

#### 3 Zephyr开发

##### 3.1 基础知识

Zephyr 系统架构（arch、boards、drivers、ext、kernel、lib、samples、scripts、subsys）。

- Zephyr 的 API 手册，包括蓝牙（GATT、GAP）、设备驱动、外设、内核服务（线程、工作队列、轮询、信号量、互斥锁、数据传输、时钟等）、电源管理等。

##### 3.2 内核服务

- 调度、中断和同步：线程、中断、工作队列、轮询（poll）、信号量、互斥锁。
- 数据传递：FIFO、LIFO、Stack、消息队列、消息邮箱、管道。
- 时间系统：内核时钟、定时器。
- 其他：CPU 空闲、原子服务。

##### 3.3 驱动开发

- 驱动模型：驱动数据结构、驱动 API。

- 外设使用：uart、gpio、pwm、dma、nvram、iic、spi、adc、mxkeypad、rtc。
- 驱动实现：SSD1306（使用 IIC） 和 ILI9341（使用 SPI）的驱动程序。

##### 3.4 蓝牙子系统

- 连接管理：建立/断开连接、自动连接、设置安全性、连接回调注册、身份认证回调。
- GAP：蓝牙使能、开始/停止广播、开始/停止扫描、开始/停止发现服务、地址操作。
- GATT：服务声明/注册、读/写特征值、发送通知、发送指示、读写客户端特征值配置。

#### 4 蓝牙开发

##### 4.1 BLE Profile 设计

- Peripheral：蓝牙使能 -> 注册回调函数 -> 注册服务 -> 开始广播 -> 接受连接 -> 提供服务。
- 广播：广播参数设置（选项、广播间隔）、广播内容设置、扫描回应内容设置。
- 服务：查看服务规范、声明服务（服务、特征值、描述符）、注册服务。学习 BAS、DATS、DIS 等服务的实现。
- 编写服务：ANS（警报通知服务）、HIDS（HID 服务）、HTS（温度测量服务）、UDS（用户数据服务）。

##### 4.2 BLE Central 设计

- Central：蓝牙使能 -> 注册回调函数 -> 开始扫描 -> 发起连接 -> 发现服务 -> 使用服务。
- 扫描：扫描参数设置（类型、重复过滤、间隔、窗口）-> 找到设备 -> 解析广播数据。
- 发现：发现主服务 -> 发现次要服务 -> 发现特征值（uuid、handle、属性）。
- 使用服务：读/写特征值（handle+1），订阅通知/指示（handle+2）。

##### 4.3 BLE 连接

- 连接：注册连接回调（已连接、连接断开、连接参数更新请求、连接参数更新、身份解析、安全性改变），更新连接参数。
- 配对：注册认证回调（显示密钥、输入密钥、确认密钥、取消配对、确认配对），设置安全等级。

##### 4.4 BLE 协议栈

- BLE 协议栈架构：Host（GATT、GAP、ATT、SM、L2CAP），Controller（HCI、LL、PHY）。

- 蓝牙 Spec：LL层（链路层状态、设备地址、物理通道、空中包格式），HCI（驱动、传输层、HCI 命令包格式、事件、LE 命令），GATT（角色、属性协议、UUID），SM（配对过程、加密工具箱）。

- Zephyr 蓝牙协议栈：

  GAP（蓝牙初始化：bt_enable -> 创建线程 -> hci_driver_open[ll_init -> hci_init -> 创建线程] -> bt_init -> hci_init -> conn_init[att_init -> smp_init -> l2cap_init] -> 执行回调，广播：设置广播参数 -> 设置设备地址 -> 发送 HCI 命令）。

  GATT（服务注册：bt_gatt_init -> 注册服务 -> db_changed，读特征值：客户端读 -> 服务器调用读函数 -> 复制数据到 buf -> 发送 buf，发送通知：att_create_pdu -> 设置 buf -> l2cap_send[将 buf 添加到 conn 的 tx_queue] -> hci_tx_thread 触发轮询事件 -> 发送 buf 到客户端）。

#### 5 遥控器开发

##### 5.1 hid

遥控器工程架构（自上而下）：应用层[BLE、状态机、定时器、按键输入、音频输入、Profile、电池、LED] -> 应用框架层[输入管理、消息管理、LED管理] -> 硬件抽象层 -> 驱动层 -> 系统启动。

应用层：

- 主函数：各模块初始化 -> 蓝牙初始化 -> 开启无操作定时器 -> 死循环[接收消息 -> 处理消息]。
- BLE：蓝牙初始化回调 -> 电池初始化 -> 初始化bas/dis/hids/ota -> 注册连接回调 -> 加载 CCC -> 切换为上电状态 -> 开启定向广播[已配对则开启定向广播，否则开启非定向广播]。
- 输入：输入初始化 -> 注册中断回调 -> 按键中断 -> 执行中断回调[发送输入消息 -> 执行应用层回调[LED指示+发送红外] -> 系统输入处理 -> 是否需要发送到 app[ 语音键（按下：开始录音，发送语音开始标志；松开：停止录音，发送语音结束标志），自定义键，HCI 键，标准 HID 键（发送 HID 键值到 app）]。
- 状态机：状态切换 -> 根据事件查表得到动作编号 -> 将状态设置为查表得到的下一状态 -> 根据动作编号得到动作函数 -> 执行函数。
- 定时器：定时器初始化（延迟工作项初始化）-> 开启定时器（提交延迟工作项）-> 定时器超时 -> 发送超时消息 -> 超时消息处理（广播、定向广播、无操作、电池、配对键按住、连接到加密、红外学习）。
- 电池：蓝牙已连接 -> 开启电池服务定时器 -> 定时器超时处理 -> 更新电量（获取电池电量，低电量处理，超低电量处理） -> 发送电量通知 -> 开启电池定时器。

驱动层：

- 电池驱动：初始化 -> 绑定 ADC 设备 -> 设置采样参数 -> 设置采样条目 -> 设置驱动api[获取电池属性（电压、电量）、设置电池属性] -> 初始化完成。

##### 5.2 no-hid

- 语音：开始录音 -> 音频格式设置 -> DMA中断配置 -> 音频输入开始 -> DMA中断处理函数[半满中断：配置DMA工作的缓冲区，全满中断：发送音频输入消息] -> 音频消息处理 -> 丢弃缓冲 -> 音频数据编码 -> 发送音频数据到app -> 停止录音 -> 音频输入停止。

- OTA服务：传输控制属性（FTC）、传输数据属性（FTD）、身份认证属性（AU）、设备配置（DC）。

  初始化：注册写回调 -> 注册 OTA 服务 -> 存储器初始化[绑定spi_nor] -> OTA唤醒定时器初始化。

#### 6 BLE 模组开发

实现一个 AT 指令程序，支持 Central 和 Peripheral 两种模式。 