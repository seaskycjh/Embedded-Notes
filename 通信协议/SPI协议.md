## SPI协议

[TOC]

### 1 简介

#### 1.1 概述

SPI 总线是同步串行总线接口，速度可超过 50 M，主要应用在 LCD EEPROM，FLASH，实时时钟，AD 转换器等。SPI 可以全双工传输数据（同时进行数据收发）。

SPI 接口一般使用 4 条线通信：

MISO：主设备数据输入，从设备数据输出。

MOSI：主设备数据输出，从设备数据输入。

SCLK：时钟信号，由主设备产生。

CS：从设备片选信号，由主设备控制。

#### 1.2 特点

优点：高速、同步、全双工、非差分、总线式、主从机通信模式。

- 可以同时发出和接收串行数据。
- 可以当作主机或从机工作。
- 提供频率可编程时钟。
- 发送结束中断标志。
- 写冲突保护，总线竞争保护等。

缺点：没有指定的流控制，没有应答机制（无法确定是否接收到数据），可靠性有一定缺陷。

### 2 协议

#### 2.1 主机和从机

从设备（Slave）使能信号由主设备（Master）进行控制，当有多个从设备时，每个从设备都有一个片选引脚接到主设备的不同引脚上，要与特定从设备进行通信时，只需将该设备对应的引脚电平拉低或拉高（一般是拉低）。

#### 2.2 SPI 模式

CPOL ：时钟极性，即空闲状态的电平。若 CPOL=0，则串行同步时钟的空闲状态为低电平；若 CPOL=1，则串行同步时钟的空闲状态为高电平。

CPHA ：时钟相位，即数据采样的时钟沿。若 CPHA=0，在串行同步时钟的第一个跳变沿数据被采样；若 CPHA=1，在串行同步时钟的第二个跳变沿数据被采样。

因此，CPOL 和 CPHA 的 4 种组合构成了 SPI 的 4 种工作模式：

| CPOL | CPHA | 通信模式                           |
| ---- | ---- | ---------------------------------- |
| 0    | 0    | 数据采样在上升沿，数据发送在下降沿 |
| 0    | 1    | 数据采样在下降沿，数据发送在上升沿 |
| 1    | 0    | 数据采样在下降沿，数据发送在上升沿 |
| 1    | 1    | 数据采样在上升沿，数据发送在下降沿 |

具体时序图如下：

![image-20200416090905772](E:\Embedded-Notes\通信协议\image-20200416090905772.png)

#### 2.3 SPI 硬件设置

使用硬件 SPI 需要设置以下参数：

- 通信方式：半双工/全双工/串行发/串行收。
- 主从模式：主机/从机。
- 数据格式：8/16/32位。
- 总线速率：最大为 18Mhz。
- 片选信号控制：硬件/软件控制。
- 数据传输顺序：数据中 MSB 在前还是 LSB 在前（即数据的首位是 MSB 还是 LSB）。

### 3 实现

3.1 SPI 写数据

```c
//模拟 SPI 写一个字节：主机模式，8 位数据格式，CPOL = 1，CPHA = 1，MSB 模式
void spi_write(u8_t byte){
    u8_t i;
    SPI_CS_CLR;
    for(i = 8; i > 0; i--){
        if(byte&0x80) SPI_MOSI_SET;	//先发送最高有效位
        else SPI_MOSI_CLR;
        SPI_SCK_CLR;	//在时钟下降沿发送数据
        SPI_SCK_SET;	//时钟空闲状态为高电平
        byte <<= 1;
    }
    SPI_CS_SET;
}
```

