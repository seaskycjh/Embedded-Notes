CAN总线

[TOC]

1 简介

1.1 概述

CAN 是 Controller Area Network 的缩写（以下称为 CAN），是 ISO 国际标准化的串行通信协议。CAN 控制器根据两根线上的电位差来判断总线电平。总线电平分为显性电平和隐性电平，二者必居其一。发送方通过使总线电平发生变化，将消息发送给接收方。

1.2 特点

- 多主控制。在总线空闲时，所有单元都可以发送消息（多主控制），而两个以上的单元 同时开始发送消息时，根据标识符（Identifier 以下称为 ID）决定优先级。
- 系统的柔软性。
- 通信速度较快，通信距离远。最高 1Mbps（距离小于40M），最远可达 10KM（速率低于5Kbps）。
- 具有错误检测、错误通知和错误恢复功能。
- 连接节点多。CAN 总线是可同时连接多个单元的总线。

2 协议

CAN协议有两个标准：ISO11898 是针对通信速率为 125Kbps~1Mbps的高速通信标准，而 ISO11519-2 是针对通信速率为 125Kbps 以下的低速通信标准。

显性电平对应逻辑 0，CAN_H 和 CAN_L 之差为 2.5V 左右。而隐性 电平对应逻辑 1，CAN_H 和 CAN_L 之差为 0V。在总线上显性电平具有优先权，只要有一个 单元输出显性电平，总线上即为显性电平。而隐形电平则具有包容的意味，只有所有的单元都 输出隐性电平，总线上才为隐性电平。

CAN 协议是通过以下 5 种类型的帧进行的：

数据帧：用于发送单元向接收单元传送数据的帧。

遥控帧：用于接收单元向具有相同 ID 的发送单元请求数据的帧。

错误帧：用于当检测出错误时向其它单元通知错误的帧。

过载帧：用于接收单元通知其尚未做好接收准备的帧。

间隔帧：用于将数据帧及遥控帧与前面的帧分离开来的帧。

2.3 数据帧

帧起始：表示数据帧开始的段。由 1 个位的显性电平表示。

仲裁段：表示该帧优先级的段。标准格式的 ID 有 11 个位，扩展格式的 ID 有 29 个位。

控制段：表示数据的字节数及保留位的段。由 6 个位构成。

数据段：数据的内容，一帧可发送 0~8 个字节的数据。

CRC 段：检查帧的传输错误的段。由 15 个位的 CRC 顺序和 1 个位的 CRC 界定符（用 于分隔的位）组成。

ACK 段：表示确认正常接收的段。由 ACK 槽(ACK Slot)和 ACK 界定符 2 个位组成。

帧结束。表示数据帧结束的段。

由发送单元在非同步的情况下发送的每秒钟的位数称为位速率。

一个位可分为 4 段。

同步段（SS）传播时间段（PTS）相位缓冲段 1（PBS1）相位缓冲段 2（PBS2）